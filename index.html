<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Persona 3D</title>
    <link rel="stylesheet" href="./style.css" />
  </head>

  <body>
    <div id="app">
      <header class="topbar">
        <div class="brand">
          <div class="dot"></div>
          <div>
            <div class="title">Persona 3D</div>
            <div class="subtitle">Essay answers • LLM scoring • Local-first</div>
          </div>
        </div>

        <div class="topbar-actions">
          <div class="bucket">
            <div class="bucket-label">Bucket</div>
            <select id="bucketSelect"></select>
          </div>

          <button id="btnReset" class="btn btn-ghost" title="Reset session (local only)">Reset</button>
          <button id="btnExport" class="btn btn-ghost" title="Export session JSON">Export</button>
          <label class="btn btn-ghost file">
            Import
            <input id="fileImport" type="file" accept="application/json" />
          </label>
        </div>
      </header>

      <main class="layout">
        <section class="panel">
          <div class="card">
            <div class="card-h">
              <div class="card-title">Current question</div>
              <div class="pill" id="pillProgress">0 pts</div>
            </div>

            <div class="q-meta" id="qMeta"></div>
            <div class="q-body" id="qBody"></div>

            <div class="row">
              <button id="btnCopyPrimer" class="btn">Copy primer</button>
              <button id="btnCopyQuestion" class="btn btn-secondary">Copy this question</button>
            </div>

            <div class="smallnote">
              Paste the primer once per bucket/session into your LLM chat. Then for each question: paste the question prompt, answer in essay form, then paste JSON back here.
            </div>
          </div>

          <div class="card">
            <div class="card-h">
              <div class="card-title">Paste LLM JSON</div>
              <div class="pill pill-warn" id="pillStatus">Waiting</div>
            </div>

            <div class="fieldrow">
              <label class="field">
                <div class="fieldlabel">Model label (optional)</div>
                <input id="modelLabel" type="text" placeholder='e.g. "GPT-5.2 Thinking"' />
              </label>
              <label class="field">
                <div class="fieldlabel">Save to bucket</div>
                <select id="bucketSelectInline"></select>
              </label>
            </div>

            <textarea id="jsonIn" spellcheck="false" placeholder='Paste the model output here (JSON only).'></textarea>

            <div class="row">
              <button id="btnParse" class="btn">Parse + save</button>
              <button id="btnNext" class="btn btn-secondary" title="Skip to next question without saving">Skip</button>
            </div>

            <div id="parseMsg" class="msg"></div>

            <details class="details">
              <summary>Clarification support</summary>
              <div class="smallnote">
                The model can set <code>needs_clarification.is_needed=true</code>. If so, the site will show the re-explain text and a re-ask prompt.
              </div>
              <div id="clarifyBox" class="clarify"></div>
            </details>
          </div>

          <div class="card">
            <div class="card-h">
              <div class="card-title">Progress</div>
              <div class="pill" id="pillQuadrant">Quadrant: —</div>
            </div>

            <div class="progress">
              <div class="progressbar">
                <div class="progressfill" id="progressFill"></div>
              </div>
              <div class="progressmeta">
                <div><span class="muted">Points:</span> <span id="ptsNow">0</span> / 100 <span class="muted">(cap)</span></div>
                <div><span class="muted">Total earned:</span> <span id="ptsTotal">0</span></div>
              </div>
            </div>

            <div class="grid2">
              <div class="kv"><div class="k">Practicality</div><div class="v" id="vPracticality">—</div></div>
              <div class="kv"><div class="k">Empathy</div><div class="v" id="vEmpathy">—</div></div>
              <div class="kv"><div class="k">Knowledge</div><div class="v" id="vKnowledge">—</div></div>
              <div class="kv"><div class="k">Wisdom</div><div class="v" id="vWisdom">—</div></div>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="kv"><div class="k">Calibration</div><div class="v" id="vCalibration">—</div></div>
              <div class="kv"><div class="k">Playfulness</div><div class="v" id="vPlayfulness">—</div></div>
            </div>

            <div class="smallnote">
              Calibration = groundedness + epistemic humility. Playfulness flags unserious answers without punishing creativity.
            </div>
          </div>

          <div id="personaCardMount"></div>

          <div class="card">
            <div class="card-h">
              <div class="card-title">Answer history</div>
              <div class="pill" id="pillSaved">Saved: 0</div>
            </div>
            <div id="history" class="history"></div>
          </div>
        </section>

        <section class="viz">
          <canvas id="c"></canvas>

          <div class="viz-top">
            <div class="qframe">
              <div class="qimgwrap">
                <img id="qImg" alt="" />
                <div id="qImgPlaceholder" class="qimgph">No image yet</div>
              </div>
              <div class="qprint">
                <div class="qprintTitle" id="qPrintTitle">—</div>
                <div class="qprintBody" id="qPrintBody">—</div>
              </div>
            </div>
          </div>

          <div class="viz-overlay">
            <div class="viz-title">Quadrant plane</div>
            <div class="viz-sub">
              x = practicality − empathy<br />
              y = wisdom − knowledge
            </div>
            <div class="viz-sub">
              Drag to rotate. Release for inertia.
            </div>
          </div>
        </section>
      </main>
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.182.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/"
        }
      }
    </script>

    <!-- QR generator (summary only) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script type="module" src="./main.js"></script>
  </body>
</html>
